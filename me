import cv2
import numpy as np
import matplotlib.pyplot as plt

# Load the image
image_path = "/mnt/data/2FC3C735-1B77-4C23-8F08-64238E7EB79A.jpeg"
image = cv2.imread(image_path)
height, width = image.shape[:2]

# Convert to grayscale
gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

# Threshold to isolate dark (black) regions
_, thresh = cv2.threshold(gray, 50, 255, cv2.THRESH_BINARY_INV)

# Apply morphological closing to connect components
kernel = np.ones((10, 10), np.uint8)
closed = cv2.morphologyEx(thresh, cv2.MORPH_CLOSE, kernel)

# Detect contours to find the black borders
contours, _ = cv2.findContours(closed, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

# Filter out smaller contours based on area (to ignore internal circles)
min_area_threshold = 10000  # Adjust this threshold based on your image
filtered_contours = [cnt for cnt in contours if cv2.contourArea(cnt) > min_area_threshold]

# Draw only the outer contour for confirmation
contour_image = image.copy()
cv2.drawContours(contour_image, filtered_contours, -1, (0, 255, 0), 2)

# Find bounding box of the largest remaining contour (assumed to be the outer border)
outer_contour = max(filtered_contours, key=cv2.contourArea)
x, y, w, h = cv2.boundingRect(outer_contour)

# Draw the top green line across the top black border
top_line_y = y  # Top border of bounding box
cv2.line(image, (x, top_line_y), (x + w, top_line_y), (0, 255, 0), 3)
cv2.putText(image, "Top Border (55.58 mm)", (x + 20, top_line_y - 10), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0, 255, 0), 2)

# Draw the left blue line along the left black border
left_line_x = x  # Left border of bounding box
cv2.line(image, (left_line_x, y), (left_line_x, y + h), (255, 0, 0), 3)
cv2.putText(image, "Left Border (Blue)", (left_line_x - 70, y + h // 2), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 0, 0), 2)

# Draw the right red line along the right black border
right_line_x = x + w  # Right border of bounding box
cv2.line(image, (right_line_x, y), (right_line_x, y + h), (0, 0, 255), 3)
cv2.putText(image, "Right Border (Red)", (right_line_x + 10, y + h // 2), cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 255), 2)

# Display the final result with adjusted borders
plt.imshow(cv2.cvtColor(image, cv2.COLOR_BGR2RGB))
plt.title("Detected Black Borders with Measurement Lines (Ignoring Circles)")
plt.show()